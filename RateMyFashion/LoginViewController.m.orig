//
//  ViewController.m
//  RateMyFashion
//
//  Created by Kai Mou on 3/28/16.
//  Copyright Â© 2016 MouZhang. All rights reserved.
//

#import "TestViewController.h"
#import "LoginViewController.h"
<<<<<<< HEAD
#import "MZUser.h"
#import "MZPhoto.h"
#import "Constants.h"
=======
>>>>>>> 83648cbe58e0f3854d185654946ca88d0dbad8fa

@interface LoginViewController ()

@end

@implementation LoginViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    
    /*
<<<<<<< HEAD
     //check if the user is already logged in
     if ([FBSDKAccessToken currentAccessToken]) {
     TestViewController *controller = [[UIStoryboard storyboardWithName:@"Main" bundle:NULL]instantiateViewControllerWithIdentifier:@"test"];
     controller.text = @"Hello World!";
     [self presentViewController:controller animated:YES completion:nil];
     }
     */
=======
    //check if the user is already logged in
    if ([FBSDKAccessToken currentAccessToken]) {
        TestViewController *controller = [[UIStoryboard storyboardWithName:@"Main" bundle:NULL]instantiateViewControllerWithIdentifier:@"test"];
        controller.user = self.user;
        [self presentViewController:controller animated:YES completion:nil];
    }
    */
>>>>>>> 83648cbe58e0f3854d185654946ca88d0dbad8fa
    
    self.loginButton = [[FBSDKLoginButton alloc] init];
    self.loginButton.center = self.view.center;
    self.loginButton.delegate = self;
    [self.view addSubview: self.loginButton];
    
    // Do any additional setup after loading the view, typically from a nib.
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

- (IBAction)buttonPressed:(id)sender {
    [self showUserInfo];
}

//login delegate method, called when user returns from the login dialog
- (void)loginButton:(FBSDKLoginButton *)loginButton
<<<<<<< HEAD
didCompleteWithResult:(FBSDKLoginManagerLoginResult *)result
              error:(NSError *)error {
    [self fetchUserInfoWithCompletionHandler:^{
        NSLog(@"Logged in");
        TestViewController *controller = [[UIStoryboard storyboardWithName:@"Main" bundle:NULL]instantiateViewControllerWithIdentifier:@"test"];
        [self presentViewController:controller animated:YES completion:nil];
    }];
=======
        didCompleteWithResult:(FBSDKLoginManagerLoginResult *)result
        error:(NSError *)error {
    if ([FBSDKAccessToken currentAccessToken]) {
        [self fetchUserInfoWithCompletionHandler:^() {
            TestViewController *controller = [[UIStoryboard storyboardWithName:@"Main" bundle:NULL]instantiateViewControllerWithIdentifier:@"test"];
            controller.user = self.user;
            [self presentViewController:controller animated:YES completion:nil];
        }];
        NSLog(@"Logged in");
    }
>>>>>>> 83648cbe58e0f3854d185654946ca88d0dbad8fa
}

- (void)loginButtonDidLogOut:(FBSDKLoginButton *)loginButton{
    [MZUser clearCurrentUser];
    
    NSLog(@"Logged out");
}

-(void) showUserInfo {
    NSLog(@"User %@", [_user description]);
    NSLog(@"User Token %@", [_user userId]);
}


-(void)fetchUserInfoWithCompletionHandler:(void (^)(void))segue {
    if([FBSDKAccessToken currentAccessToken]){
<<<<<<< HEAD
        
        [[[FBSDKGraphRequest alloc] initWithGraphPath:@"me"
                                           parameters:@{@"fields": @"id, name, link, first_name, last_name, email"}]
         startWithCompletionHandler:^(FBSDKGraphRequestConnection *connection, id result, NSError *error) {
             if (!error) {
                 if([result isKindOfClass:[NSDictionary class]]) {
                     NSDictionary *jsonDict = (NSDictionary * )result;
                     MZUser *user = [[MZUser alloc] initWithJSON:jsonDict andAccessToken:[[FBSDKAccessToken currentAccessToken] tokenString]];
                     [MZUser setCurrentUser:user];
                     segue();
                 }
             }
             else {
                 NSLog(@"There was an error %@", error);
             }
         }];
=======

        [[[FBSDKGraphRequest alloc] initWithGraphPath:@"me" 
                                    parameters:@{@"fields": @"id, name, link, first_name, last_name, email"}]
                                    startWithCompletionHandler:^(FBSDKGraphRequestConnection *connection, id result, NSError *error) {
                                        if (!error) {
                                            if([result isKindOfClass:[NSDictionary class]]) {
                                                NSDictionary *jsonDict = (NSDictionary *)result;
                                                self.user = [[MZUser alloc] initWithJSON:jsonDict andAccessToken:[[FBSDKAccessToken currentAccessToken] tokenString]];
                                                segue();
                                            }
                                        }
                                        else
                                            NSLog(@"There was an error %@", error);
                                        
        }];
>>>>>>> 83648cbe58e0f3854d185654946ca88d0dbad8fa
    }
}

@end
